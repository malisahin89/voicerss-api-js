// https://github.com/malisahin89
jQuery.extend({
    speech: function (e) {
        var malisahin89 = e.src;
        $.ajax({
            type: "POST",
            url: "https://api.voicerss.org/",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            data: this._buildRequest(e),
            dataType: "text",
            success: function (e, a, c) {
                if (0 == e.indexOf("ERROR")) throw e;

                function base64ToBlob(base64Data) {
                    var binaryString = window.atob(base64Data.split(",")[1]);
                    var arrayBuffer = new ArrayBuffer(binaryString.length);
                    var byteArray = new Uint8Array(arrayBuffer);
                    for (var i = 0; i < binaryString.length; i++) {
                        byteArray[i] = binaryString.charCodeAt(i);
                    }
                    return new Blob([arrayBuffer], { type: "audio/mpeg" });
                }
                function saveBlobToFile(blob, fileName) {
                    var link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                var base64Data = e;
                var blob = base64ToBlob(base64Data);

                var slug = malisahin89.toLowerCase();
                slug = slug.replace(/\s+/g, "-");
                slug = slug.replace(/[^\w\-]+/g, "");
                var file = slug.substring(0, 15);

                var fileName = file + ".mp3";
                saveBlobToFile(blob, fileName);
            },
        });
    },

    _buildRequest: function (e) {
        var a = e.c && "auto" != e.c.toLowerCase() ? e.c : this._detectCodec();
        return (
            "key=" +
            (e.key || "") +
            "&src=" +
            (e.src || "") +
            "&hl=" +
            (e.hl || "") +
            "&v=" +
            (e.v || "") +
            "&r=" +
            (e.r || "") +
            "&c=" +
            (a || "") +
            "&f=" +
            (e.f || "") +
            "&ssml=" +
            (e.ssml || "") +
            "&b64=true"
        );
    },
});
